<!DOCTYPE html>
<html class="core" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>FT Labs Experiment: Crossword DSL parser</title>
		<!--
			Perform your cuts the mustard test.
			For information about what features come bundled with other
			features in all browsers, see caniuse.com
		-->
		<script>
			var cutsTheMustard = ('querySelector' in document && 'localStorage' in window && 'addEventListener' in window);

			if (cutsTheMustard) {
				// Swap the `core` class on the HTML element for an `enhanced` one
				// We're doing it early in the head to avoid a flash of unstyled content
				document.documentElement.className = document.documentElement.className.replace(/\bcore\b/g, 'enhanced');
			}
		</script>

	   	<style>
			/* Hide any enhanced experience content when in core mode, and vice versa. */
			.core .o--if-js,
			.enhanced .o--if-no-js { display: none !important; }

			body {
				/* Remove space around the document */
				margin: 0;
			}
			html {
				/* Set a font family on the whole document */
				font-family: Georgia, serif;

				/* Prevent navigation menus from creating
				   extra space on sides of the page */
				overflow-x: hidden;

			    font-family: BentonSans, sans-serif;
			    padding: 0;
			    margin: 0;
			    width: 100%;
			    height: 100%;
			}
			h1 {
			    font-family: MillerDisplay, serif;
			    text-align: center;
			    font-size: 300%;
			    font-size: 6.2vw;
			}
			body {
			    background-color: #fff1e0;
			}
   		</style>

		<link rel="stylesheet" href="//origami-build.ft.com/v2/bundles/css?modules=o-fonts@^2,o-icons@^5.2.0,o-teaser@^1.3.1,o-header-services@^1.0.2" />
	
		<script src="//polyfill.webservices.ft.com/v1/polyfill.min.js"></script>

		<script type="text/javascript">
			var CrosswordDSL = (function() {

				function parse(text){
					var crossword = {
						version : "standard v1",
						pubdate : "today",
					 dimensions : "17x17",
						 across : [],
						   down : [],
						 errors : [],
					};
					var match;
					var clue;
					var cluesGrouping;
					var lines = text.split(/\r|\n/);
					lines.forEach(function(line){
						// strip out comments
						if (match = /^([^\#]*)\#.*$/.exec(line) ) {
							line = match[1];
						}
						// strip out trailing and leading spaces
						line = line.trim();
						// ignore blank lines
						if (line === "") {
							// do nothing
						} else if (match = /^version\s+(.+)$/i.exec(line) ) {
							crossword.version = match[1]; 
						} else if (match = /^id\s+(.+)$/i.exec(line) ) {
							crossword.id = match[1]; 
						} else if (match = /^pubdate\s+(\d\d\d\d\/\d\d\/\d\d)$/i.exec(line) ) {
							crossword.pubdate = match[1]; 
						} else if (match = /^size\s+(15x15|17x17)$/i.exec(line) ) {
							crossword.dimensions = match[1]; 
						} else if (match = /^(across|down)$/i.exec(line) ) {
							cluesGrouping = match[1]; 
						} else if (match = /^\[(\d+),(\d+)\]\s+(\d+)\.\s+(.+)\s+\(([A-Z,-]+)\)$/.exec(line) ) {
							if (! /(across|down)/.test(cluesGrouping)) {
								crossword.errors.push("ERROR: clue specified but no 'across' or 'down' grouping specified");
							} else {
								clue = {
									coordinates : [ parseInt(match[1]), parseInt(match[2]) ],
									         id : parseInt(match[3]),
									       body : match[4],
									  answerCSV : match[5],
									   original : line,
								}; 
								crossword[cluesGrouping].push(clue);
							}
						} else {
							crossword.errors.push("ERROR: couldn't parse line: " + line);
						}
					});

					return crossword;
				}

				function validateCrossword( crossword ){
					var maxCoord = parseInt(crossword.dimensions.split('x')[0]);
					var grid = new Array( maxCoord * maxCoord ).fill(' ');
					crossword.grid = grid;
					var wordsString, x, y;

					for(let clue of crossword.across){
						function clueError(msg){
							crossword.errors.push("Error: " + msg + " in clue=" + clue.original);
						}
						x = clue.coordinates[0];
						if (x > maxCoord) {
							clueError("x coord too large");
							break;
						}
						y = clue.coordinates[1];
						if (y > maxCoord) {
							clueError("y coord too large");
							break;
						}

						wordsString = clue.answerCSV.split(/[,-]/).join('');
						if (wordsString.length > maxCoord) {
							clueError("answer too long for crossword");
							break;
						}

						if (wordsString.length + x > maxCoord) {
							clueError("answer too long for crossword from that coord");
							break;
						}
					}

					return crossword;
				}

				function getElementByClass(name) {
					return document.getElementsByClassName(name)[0];
				}

				function getElementById(id) {
					return document.getElementById(id);
				}

				function updateSpec() {
					var initialText = getElementById('dsl').value;
					var crossword = parse(initialText);
					console.log("crossword=", crossword);
					crossword = validateCrossword(crossword);
					console.log("validated crossword=", crossword);
					var specText;
					if (crossword.errors.length > 0) {
						specText = crossword.errors.join("\n");
					} else {
						specText = JSON.stringify(crossword);
					}
					var specElt = getElementById('spec');
					specElt.value = specText;
				}

				function invoke(){
					console.log("invoked");
					updateSpec();
					var buttonElt = getElementById('update-button');
					buttonElt.onclick = updateSpec;
				}

				return {
					invoke: invoke
				}
			})();
		</script>
	</head>
	<body>
		<header class="o-header-services" data-o-component="o-header">
			<div class="o-header-services__top o-header-services__container">
				<div class="o-header-services__ftlogo"></div>
				<div class="o-header-services__title">
					<h1 class="o-header-services__product-name"><a href="/">FT Labs experiment</a></h1><span class="o-header-subrand__product-tagline ">Crossword DSL</span>
				</div>
			</div>
		</header>

		<h2>type in the crossword details</h2>

		<textarea rows="20" cols="80" id="dsl">
version standard v1
id 00001
pubdate 2017/01/08
size 17x17 # or 15x15
across
[1,1] 1. Gges (SCRAMBLED,EGGS)
down
[1,1] 1. Gges (SCRAMBLED,EGGS)		
#
# [coordinates of clue in grid: x=across, y=down]
# (words in answer are captialised, and separated by commas or hyphens)
		</textarea>
		<BR>
		<button type="button" id="update-button">Update</button>

		<h2>crossword data structure</h2>

		<div class="crossword-data"></div>

		<textarea rows="10" cols="80" onclick="this.focus();this.select()" readonly="readonly" id="spec">
		</textarea>

		<script type="text/javascript">
			document.addEventListener('DOMContentLoaded', CrosswordDSL.invoke );
		</script>

	</body>
</html>